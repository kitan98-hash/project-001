<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¬ê³  í˜„í™©</title>

  <!-- CSV íŒŒì‹± (ë”°ì˜´í‘œ/ì‰¼í‘œ/ì¤„ë°”ê¿ˆ ì•ˆì „) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg: #eef1ff;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --line: rgba(17,24,39,.08);
      --primary: #5b5ce6;
      --primary-2: #7c3aed;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(17,24,39,.10);
      --radius: 22px;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, #ffffff 0%, var(--bg) 55%, #f6f7ff 100%);
      color: var(--text);
      padding: 18px;
    }

    .phone{ max-width: 420px; margin: 0 auto; border-radius: 32px; background: rgba(255,255,255,.55); padding: 14px; }
    .app{
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(255,255,255,.6);
      border-radius: 28px;
      padding: 18px 16px 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .topbar{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 14px; }
    .month{ font-size: 22px; font-weight: 800; letter-spacing: -.02em; }
    .right{ display:flex; gap:10px; align-items:center; }

    .iconbtn{
      width: 38px; height: 38px; border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.9);
      display:grid; place-items:center; cursor:pointer;
    }
    .iconbtn:active{ transform: translateY(1px); }

    .reload{
      padding: 10px 12px; border-radius: 12px; border: 0; cursor:pointer;
      color: white; font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      box-shadow: 0 10px 20px rgba(91,92,230,.25);
    }
    .reload:active{ transform: translateY(1px); }

    .statusline{
      font-size: 12px; color: var(--muted);
      margin: 8px 0 14px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.85);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px; color: var(--muted);
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--muted); display:inline-block; }
    .dot.ok{ background: var(--success); }
    .dot.bad{ background: var(--danger); }

    .section-title{
      font-weight: 800; letter-spacing: -.02em;
      margin: 14px 0 10px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .section-title small{ color: var(--muted); font-weight: 700; }

    .task{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px 12px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      box-shadow: 0 10px 20px rgba(17,24,39,.06);
      margin-bottom: 10px;
    }
    .badge{
      width: 44px; height: 44px; border-radius: 16px;
      display:grid; place-items:center;
      background: rgba(91,92,230,.12);
      border: 1px solid rgba(91,92,230,.22);
      color: var(--primary);
      font-weight: 900;
      flex: 0 0 auto;
      margin-top: 2px;
    }
    .task-main{ flex:1; min-width: 0; }
    .task-title{
      font-weight: 900; margin:0; font-size: 14px; letter-spacing: -.01em;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .task-sub{
      margin-top: 8px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .chip{
      font-size: 11px; font-weight: 800;
      padding: 7px 10px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.85);
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
    }

    .chip.order{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); color: #9a6b10; }
    .chip.none{ background: rgba(107,114,128,.10); border-color: rgba(107,114,128,.18); color: #6b7280; }

    .chip input{
      width: 70px;
      border: 0;
      outline: none;
      background: transparent;
      color: var(--text);
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      text-align: right;
    }
    .chip select{
      border:0;
      outline:none;
      background: transparent;
      color: var(--text);
      font-weight: 900;
    }
    .chip .label{ opacity:.9; white-space: nowrap; }

    .need{
      font-variant-numeric: tabular-nums;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.9);
      min-width: 58px;
      text-align: center;
      flex: 0 0 auto;
      align-self: center;
      margin-top: 6px;
    }
    .need.good{ color: var(--danger); border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.08); }
    .need.ok{ color: var(--success); border-color: rgba(16,185,129,.25); background: rgba(16,185,129,.08); }
    .need.zero{ color: var(--muted); }

    .actions{
      display:flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
      margin-top: 6px;
    }
    .savebtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight: 900;
    }
    .savebtn.primary{
      color: white;
      border: 0;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      box-shadow: 0 10px 18px rgba(91,92,230,.20);
    }
    .savebtn:disabled{ opacity: .6; cursor:not-allowed; }

    .footer-note{ margin-top: 12px; font-size: 12px; color: var(--muted); }
    .error{ color: var(--danger); font-weight: 800; }
  </style>
</head>

<body>
  <div class="phone">
    <div class="app">
      <div class="topbar">
        <div class="month" id="monthText">ì¬ê³  í˜„í™©</div>
        <div class="right">
          <button class="reload" id="reloadBtn" type="button">Reload</button>
          <button class="iconbtn" id="openCsvBtn" type="button" title="CSV ì—´ê¸°" aria-label="CSV ì—´ê¸°">ğŸ”—</button>
        </div>
      </div>

      <div class="statusline" id="statusLine">
        <span class="pill"><span class="dot" id="dot"></span><span id="statusText">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span></span>
        <span class="pill">Rows: <b id="rowsCount">-</b></span>
        <span class="pill">Updated: <b id="updatedAt">-</b></span>
      </div>

      <div id="list"></div>

      <div class="footer-note">
        âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê°’ ë³€ê²½ â†’ <b>Reload</b><br/>
        âœ… ì›¹ì—ì„œ ê°’ ìˆ˜ì • â†’ <b>Save</b> â†’ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë°˜ì˜
      </div>
    </div>
  </div>

<script>
  /***** 1) ì½ê¸°(CSV) *****/
  const SHEET_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQj502UJ7RPuSmXEAGx6d5W4O9JKxrcz-zL7afDTJXOEYLOa2K1Tjw3118RrpNBjfjPNF0eV4s15BZX/pub?output=csv";

  /***** 2) ì“°ê¸°(Apps Script Web App) *****/
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbziRjAzN3ezrJ86decGH9_VfDDrYfcQplvz85w4DnnJG5kXCRb4CpAgjOH2Pz5MB5vGLA/exec"; // âœ… ì—¬ê¸°! /exec ë¡œ ëë‚˜ëŠ” URL ë¶™ì—¬ë„£ê¸°
  const API_KEY = ""; // âœ… Apps Scriptì˜ API_KEYì™€ ë™ì¼(í…ŒìŠ¤íŠ¸ë©´ "")

  const statusText = document.getElementById("statusText");
  const dot = document.getElementById("dot");
  const rowsCount = document.getElementById("rowsCount");
  const updatedAt = document.getElementById("updatedAt");
  const list = document.getElementById("list");

  document.getElementById("reloadBtn").addEventListener("click", load);
  document.getElementById("openCsvBtn").addEventListener("click", () => window.open(SHEET_URL, "_blank"));

  function setStatus(msg, ok=null){
    statusText.textContent = msg;
    dot.classList.remove("ok","bad");
    if (ok === true) dot.classList.add("ok");
    if (ok === false) dot.classList.add("bad");
  }

  function normalizeHeader(h){
    const s = String(h || "").trim();
    if (!s) return "";
    const low = s.toLowerCase();
    if (low === "currcnt") return "Current";
    return s;
  }

  function forwardFill(rows, idx){
    let last = "";
    for (const r of rows){
      const v = String(r[idx] ?? "").trim();
      if (v) last = v;
      else r[idx] = last;
    }
    return rows;
  }

  function num(v){
    const n = Number(String(v ?? "").trim());
    return Number.isFinite(n) ? n : null;
  }

  function chipClass(status){
    const s = String(status ?? "").trim().toLowerCase();
    if (s === "order") return "chip order";
    if (s === "none") return "chip none";
    return "chip";
  }

  function needClass(need){
    const n = num(need);
    if (n === null) return "need zero";
    if (n > 0) return "need ok";
    if (n < 0) return "need good";
    return "need zero";
  }

  function groupBySubject(rows, subjectIdx){
    const groups = new Map();
    for (const r of rows){
      const s = String(r[subjectIdx] ?? "").trim() || "(no subject)";
      if (!groups.has(s)) groups.set(s, []);
      groups.get(s).push(r);
    }
    return groups;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  /***** JSONP í˜¸ì¶œ (Apps Script CORS íšŒí”¼ìš©) *****/
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("timeout"));
      }, 12000);

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      function cleanup(){
        clearTimeout(timeout);
        try { delete window[cb]; } catch(e) { window[cb] = undefined; }
        script.remove();
      }

      script.onerror = () => {
        cleanup();
        reject(new Error("jsonp error"));
      };

      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb);
      document.body.appendChild(script);
    });
  }

  async function updateToSheet({title, current, tobe, status, result}){
    if (!WEBAPP_URL || WEBAPP_URL.includes("PUT_YOUR_EXEC_URL_HERE")) {
      throw new Error("WEBAPP_URLì„ /exec URLë¡œ ì„¤ì •í•´ ì£¼ì„¸ìš”.");
    }

    const qs = new URLSearchParams();
    qs.set("action", "update");
    qs.set("apiKey", API_KEY);
    qs.set("title", title);
    qs.set("current", current);
    qs.set("tobe", tobe);
    qs.set("status", status);
    qs.set("result", result);
    qs.set("t", String(Date.now())); // ìºì‹œ ë°©ì§€

    const url = WEBAPP_URL + (WEBAPP_URL.includes("?") ? "&" : "?") + qs.toString();
    return await jsonp(url);
  }

  function render(groups, idx){
    list.innerHTML = "";

    for (const [subject, rows] of groups.entries()){
      const section = document.createElement("div");
      const title = document.createElement("div");
      title.className = "section-title";
      title.innerHTML = `<span>Subject ${escapeHtml(subject)}</span><small>${rows.length} items</small>`;
      section.appendChild(title);

      rows.forEach(r => {
        const task = document.createElement("div");
        task.className = "task";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = subject;

        const main = document.createElement("div");
        main.className = "task-main";

        const h = document.createElement("p");
        h.className = "task-title";
        const rowTitle = String(r[idx.title] ?? "").trim();
        h.textContent = rowTitle;

        const current = String(r[idx.current] ?? "").trim();
        const tobe = String(r[idx.tobe] ?? "").trim();
        const need = String(r[idx.need] ?? "").trim();
        const status = String(r[idx.status] ?? "").trim();
        const result = String(r[idx.result] ?? "").trim();

        const sub = document.createElement("div");
        sub.className = "task-sub";

        sub.innerHTML = `
          <div class="chip"><span class="label">Current</span>
            <input type="number" class="inp-current" value="${escapeHtml(current)}" />
          </div>
          <div class="chip"><span class="label">To be</span>
            <input type="number" class="inp-tobe" value="${escapeHtml(tobe)}" />
          </div>
          <div class="${chipClass(status)}"><span class="label">Status</span>
            <select class="inp-status">
              <option value="none" ${status.toLowerCase()==="none"?"selected":""}>none</option>
              <option value="order" ${status.toLowerCase()==="order"?"selected":""}>order</option>
            </select>
          </div>
          <div class="chip"><span class="label">Result</span>
            <input type="text" class="inp-result" value="${escapeHtml(result)}" />
          </div>
        `;

        const needBox = document.createElement("div");
        needBox.className = needClass(need);
        needBox.textContent = need;

        const actions = document.createElement("div");
        actions.className = "actions";

        const saveBtn = document.createElement("button");
        saveBtn.className = "savebtn primary";
        saveBtn.textContent = "Save";

        saveBtn.addEventListener("click", async () => {
          try{
            saveBtn.disabled = true;
            setStatus(`ì €ì¥ ì¤‘â€¦ (${rowTitle})`, null);

            const newCurrent = task.querySelector(".inp-current").value;
            const newTobe = task.querySelector(".inp-tobe").value;
            const newStatus = task.querySelector(".inp-status").value;
            const newResult = task.querySelector(".inp-result").value;

            const res = await updateToSheet({
              title: rowTitle,
              current: newCurrent,
              tobe: newTobe,
              status: newStatus,
              result: newResult
            });

            if (!res || res.ok !== true) {
              throw new Error(res?.error || "unknown error");
            }

            setStatus(`ì €ì¥ ì™„ë£Œ âœ… (${rowTitle})`, true);

            // ì €ì¥ í›„ í•„ìš”í•˜ë©´ ìë™ Reload (ê²€ì¦ìš©)
            await load();

          }catch(e){
            setStatus("ì €ì¥ ì‹¤íŒ¨: " + (e?.message || e), false);
            console.error(e);
          }finally{
            saveBtn.disabled = false;
          }
        });

        actions.appendChild(saveBtn);

        main.appendChild(h);
        main.appendChild(sub);

        task.appendChild(badge);
        task.appendChild(main);
        task.appendChild(needBox);
        task.appendChild(actions);

        section.appendChild(task);
      });

      list.appendChild(section);
    }
  }

  async function load(){
    try{
      setStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦", null);
      rowsCount.textContent = "-";
      updatedAt.textContent = "-";
      list.innerHTML = "";

      const url = SHEET_URL + (SHEET_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("CSV fetch failed: " + res.status);

      const csvText = await res.text();
      const parsed = Papa.parse(csvText, { skipEmptyLines: true });

      if (!parsed.data || parsed.data.length < 2) throw new Error("CSV ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");

      const rows = parsed.data.map(r => r.map(c => String(c ?? "")));

      // í—¤ë” ì°¾ê¸°
      let headerRowIndex = -1;
      for (let i=0; i<rows.length; i++){
        const low = rows[i].map(x => x.trim().toLowerCase());
        if (low.includes("subject") && low.includes("title")){
          headerRowIndex = i; break;
        }
      }
      if (headerRowIndex === -1) headerRowIndex = 0;

      const headers = rows[headerRowIndex].map(normalizeHeader);
      const dataRows = rows.slice(headerRowIndex + 1).filter(r => r.some(v => String(v ?? "").trim() !== ""));

      const hLow = headers.map(h => String(h).trim().toLowerCase());
      const idx = {
        subject: hLow.indexOf("subject"),
        title: hLow.indexOf("title"),
        current: hLow.indexOf("current"),
        tobe: hLow.indexOf("to be"),
        need: hLow.indexOf("need"),
        status: hLow.indexOf("status"),
        result: hLow.indexOf("result")
      };

      if (idx.subject < 0 || idx.title < 0) throw new Error("í—¤ë”ì— Subject/Title ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.");

      forwardFill(dataRows, idx.subject);

      const groups = groupBySubject(dataRows, idx.subject);
      render(groups, idx);

      rowsCount.textContent = String(dataRows.length);
      updatedAt.textContent = new Date().toLocaleString();
      setStatus("ì •ìƒ ë¡œë“œ ì™„ë£Œ", true);

    }catch(e){
      setStatus("ë¡œë“œ ì‹¤íŒ¨: " + (e?.message || e), false);
      list.innerHTML = `<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
