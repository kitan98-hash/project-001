<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¬ê³  í˜„í™©</title>

  <!-- CSV íŒŒì‹± (ë”°ì˜´í‘œ/ì‰¼í‘œ/ì¤„ë°”ê¿ˆ ì•ˆì „) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#eef1ff; --text:#111827; --muted:#6b7280; --line:rgba(17,24,39,.08);
      --primary:#5b5ce6; --primary2:#7c3aed;
      --success:#10b981; --danger:#ef4444; --shadow:0 10px 30px rgba(17,24,39,.10);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 700px at 20% 10%, #fff 0%, var(--bg) 55%, #f6f7ff 100%);
      color:var(--text);
    }
    .phone{max-width:420px;margin:0 auto;border-radius:32px;background:rgba(255,255,255,.55);padding:14px}
    .app{
      background:rgba(255,255,255,.75); border:1px solid rgba(255,255,255,.6);
      border-radius:28px; padding:18px 16px 16px; box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .month{font-size:22px;font-weight:900;letter-spacing:-.02em}
    .right{display:flex;gap:10px;align-items:center}
    .reload{
      padding:10px 12px;border-radius:12px;border:0;cursor:pointer;color:#fff;font-weight:900;
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      box-shadow:0 10px 20px rgba(91,92,230,.25)
    }
    .reload:active{transform:translateY(1px)}
    .iconbtn{
      width:38px;height:38px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.9);display:grid;place-items:center;cursor:pointer
    }
    .iconbtn.small{width:32px;height:32px;border-radius:10px;font-size:14px}
    .iconbtn:active{transform:translateY(1px)}
    .statusline{font-size:12px;color:var(--muted);margin:8px 0 14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:rgba(255,255,255,.85);padding:6px 10px;border-radius:999px}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted)}
    .dot.ok{background:var(--success)} .dot.bad{background:var(--danger)}
    .checklist{margin:6px 0 14px;color:var(--muted);font-size:12px;line-height:1.6}
    .checklist b{color:#111827}
    .section-title{font-weight:900;letter-spacing:-.02em;margin:14px 0 10px;display:flex;align-items:center;justify-content:space-between}
    .section-title small{color:var(--muted);font-weight:800}
    .task{
      background:rgba(255,255,255,.92); border:1px solid var(--line); border-radius:var(--radius);
      padding:12px; display:flex; gap:12px; align-items:flex-start;
      box-shadow:0 10px 20px rgba(17,24,39,.06); margin-bottom:10px;
    }
    .badge{
      width:44px;height:44px;border-radius:16px;display:grid;place-items:center;
      background:rgba(91,92,230,.12);border:1px solid rgba(91,92,230,.22);
      color:var(--primary);font-weight:1000;flex:0 0 auto;
    }
    .task-main{flex:1;min-width:0}
    .task-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .task-title{margin:0;font-weight:1000;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .task-sub{margin-top:6px;font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{font-size:11px;font-weight:900;padding:5px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.85);color:var(--muted)}
    .chip.order{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.25);color:#9a6b10}
    .chip.none{background:rgba(107,114,128,.10);border-color:rgba(107,114,128,.18);color:#6b7280}
    .need{
      font-variant-numeric:tabular-nums;font-weight:1000;padding:6px 10px;border-radius:12px;
      border:1px solid var(--line);background:rgba(255,255,255,.9);min-width:58px;text-align:center;flex:0 0 auto;margin-top:2px
    }
    .need.ok{color:var(--success);border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.08)}
    .need.good{color:var(--danger);border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08)}
    .need.zero{color:var(--muted)}
    .editor{
      margin-top:10px;padding:10px;border:1px dashed rgba(17,24,39,.18);border-radius:16px;
      background:rgba(255,255,255,.85);display:none
    }
    .editor.open{display:block}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field label{display:block;font-size:11px;font-weight:900;color:var(--muted);margin-bottom:6px}
    .field input,.field select{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(17,24,39,.12);background:#fff;font-size:13px;outline:none}
    .actions{display:flex;gap:10px;margin-top:10px;justify-content:flex-end;align-items:center}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(17,24,39,.10);background:rgba(255,255,255,.95);cursor:pointer;font-weight:1000;font-size:12px}
    .btn.primary{border:0;color:#fff;background:linear-gradient(135deg,var(--primary),var(--primary2));box-shadow:0 10px 20px rgba(91,92,230,.22)}
    .btn:active{transform:translateY(1px)}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(17,24,39,.92);color:#fff;padding:10px 12px;border-radius:12px;
      font-size:12px;font-weight:900;opacity:0;pointer-events:none;transition:opacity .18s ease;max-width:92vw;text-align:center
    }
    .toast.show{opacity:1}
    .error{color:var(--danger);font-weight:1000}
  </style>
</head>

<body>
  <div class="phone">
    <div class="app">
      <div class="topbar">
        <div class="month">ì¬ê³  í˜„í™©</div>
        <div class="right">
          <button class="reload" id="reloadBtn" type="button">Reload</button>
          <button class="iconbtn" id="openCsvBtn" type="button" title="CSV ì—´ê¸°">ğŸ”—</button>
        </div>
      </div>

      <div class="statusline">
        <span class="pill"><span class="dot" id="dot"></span><span id="statusText">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span></span>
        <span class="pill">Rows: <b id="rowsCount">-</b></span>
        <span class="pill">Updated: <b id="updatedAt">-</b></span>
      </div>

      <div class="checklist">
        âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê°’ ë³€ê²½ â†’ <b>Reload</b><br/>
        âœ… ì›¹ì—ì„œ ê°’ ìˆ˜ì • â†’ <b>Save</b> â†’ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë°˜ì˜
      </div>

      <div id="list"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  /**
   * =========================
   * ë°˜ë“œì‹œ ë³¸ì¸ ê°’ìœ¼ë¡œ ìˆ˜ì •
   * =========================
   */

  // (1) CSV ë§í¬: "ì›¹ì— ê²Œì‹œ"ë¡œ ì–»ì€ output=csv ë§í¬ ì‚¬ìš©
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQj502UJ7RPuSmXEAGx6d5W4O9JKxrcz-zL7afDTJXOEYLOa2K1Tjw3118RrpNBjfjPNF0eV4s15BZX/pub?output=csv";

  // (2) Apps Script ì›¹ì•± /exec (ping ì„±ê³µí–ˆë˜ URL)
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbziRjAzN3ezrJ86decGH9_VfDDrYfcQplvz85w4DnnJG5kXCRb4CpAgjOH2Pz5MB5vGLA/exec";

  // (ì„ íƒ) Apps Scriptì—ì„œ API_KEYë¥¼ ì“°ëŠ” ê²½ìš°ë§Œ ë™ì¼í•˜ê²Œ ì…ë ¥
  const API_KEY = "";

  /**
   * =========================
   * UI
   * =========================
   */
  const statusText = document.getElementById("statusText");
  const dot = document.getElementById("dot");
  const rowsCount = document.getElementById("rowsCount");
  const updatedAt = document.getElementById("updatedAt");
  const list = document.getElementById("list");
  const toastEl = document.getElementById("toast");

  document.getElementById("reloadBtn").addEventListener("click", load);
  document.getElementById("openCsvBtn").addEventListener("click", () => window.open(SHEET_URL, "_blank"));

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.classList.remove("show"), 2200);
  }
  function setStatus(msg, ok=null){
    statusText.textContent = msg;
    dot.classList.remove("ok","bad");
    if (ok === true) dot.classList.add("ok");
    if (ok === false) dot.classList.add("bad");
  }

  /**
   * =========================
   * CSV helpers
   * =========================
   */
  function normalizeHeader(h){
    const s = String(h || "").trim();
    const low = s.toLowerCase();
    if (low === "currcnt") return "Current";
    return s;
  }
  function forwardFill(rows, idx){
    let last = "";
    for (const r of rows){
      const v = String(r[idx] ?? "").trim();
      if (v) last = v;
      else r[idx] = last;
    }
    return rows;
  }
  function num(v){
    const n = Number(String(v ?? "").trim());
    return Number.isFinite(n) ? n : null;
  }
  function chipClass(status){
    const s = String(status ?? "").trim().toLowerCase();
    if (s === "order") return "chip order";
    if (s === "none") return "chip none";
    return "chip";
  }
  function needClass(need){
    const n = num(need);
    if (n === null) return "need zero";
    if (n > 0) return "need ok";
    if (n < 0) return "need good";
    return "need zero";
  }
  function groupBySubject(rows, subjectIdx){
    const groups = new Map();
    for (const r of rows){
      const s = String(r[subjectIdx] ?? "").trim() || "(no subject)";
      if (!groups.has(s)) groups.set(s, []);
      groups.get(s).push(r);
    }
    return groups;
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function render(groups, idx){
    list.innerHTML = "";

    for (const [subject, rows] of groups.entries()){
      const section = document.createElement("div");

      const title = document.createElement("div");
      title.className = "section-title";
      title.innerHTML = `<span>Subject ${escapeHtml(subject)}</span><small>${rows.length} items</small>`;
      section.appendChild(title);

      rows.forEach(r => {
        const titleText = String(r[idx.title] ?? "").trim();
        const current = String(r[idx.current] ?? "").trim();
        const tobe = String(r[idx.tobe] ?? "").trim();
        const need = String(r[idx.need] ?? "").trim();
        const status = String(r[idx.status] ?? "").trim();
        const result = String(r[idx.result] ?? "").trim();

        const task = document.createElement("div");
        task.className = "task";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = subject;

        const main = document.createElement("div");
        main.className = "task-main";

        const top = document.createElement("div");
        top.className = "task-top";

        const h = document.createElement("p");
        h.className = "task-title";
        h.textContent = titleText;

        const editBtn = document.createElement("button");
        editBtn.className = "iconbtn small";
        editBtn.type = "button";
        editBtn.title = "Edit";
        editBtn.textContent = "âœï¸";

        top.appendChild(h);
        top.appendChild(editBtn);

        const sub = document.createElement("div");
        sub.className = "task-sub";
        sub.innerHTML = `
          <span class="chip">Current: <b>${escapeHtml(current)}</b></span>
          <span class="chip">To be: <b>${escapeHtml(tobe)}</b></span>
          <span class="${chipClass(status)}">Status: <b>${escapeHtml(status)}</b></span>
          <span class="chip">Result: <b>${escapeHtml(result)}</b></span>
        `;

        const editor = document.createElement("div");
        editor.className = "editor";
        editor.innerHTML = `
          <div class="grid">
            <div class="field">
              <label>Current</label>
              <input inputmode="numeric" type="number" step="1" class="edit-current" value="${escapeHtml(current)}" />
            </div>
            <div class="field">
              <label>To be</label>
              <input inputmode="numeric" type="number" step="1" class="edit-tobe" value="${escapeHtml(tobe)}" />
            </div>
            <div class="field">
              <label>Status</label>
              <select class="edit-status">
                <option value="">(blank)</option>
                <option value="none">none</option>
                <option value="order">order</option>
              </select>
            </div>
            <div class="field">
              <label>Result</label>
              <input type="text" class="edit-result" value="${escapeHtml(result)}" />
            </div>
          </div>
          <div class="actions">
            <button class="btn" type="button" data-act="cancel">Cancel</button>
            <button class="btn primary" type="button" data-act="save">Save</button>
          </div>
        `;

        const statusSel = editor.querySelector(".edit-status");
        statusSel.value = status;

        const needBox = document.createElement("div");
        needBox.className = needClass(need);
        needBox.textContent = need;

        const curInput = editor.querySelector(".edit-current");
        const tobeInput = editor.querySelector(".edit-tobe");
        function updateNeedPreview(){
          const c = num(curInput.value);
          const t = num(tobeInput.value);
          if (c === null || t === null) return;
          const n = t - c;
          needBox.textContent = String(n);
          needBox.className = "need " + (n > 0 ? "ok" : n < 0 ? "good" : "zero");
        }
        curInput.addEventListener("input", updateNeedPreview);
        tobeInput.addEventListener("input", updateNeedPreview);

        editBtn.addEventListener("click", () => editor.classList.toggle("open"));

        editor.addEventListener("click", async (ev) => {
          const act = ev.target?.dataset?.act;
          if (!act) return;

          if (act === "cancel"){
            curInput.value = current;
            tobeInput.value = tobe;
            statusSel.value = status;
            editor.querySelector(".edit-result").value = result;
            needBox.textContent = need;
            needBox.className = needClass(need);
            editor.classList.remove("open");
            return;
          }

          if (act === "save"){
            const newCurrent = curInput.value;
            const newTobe = tobeInput.value;
            const newStatus = statusSel.value;
            const newResult = editor.querySelector(".edit-result").value;

            if (!titleText){
              toast("Titleì´ ë¹„ì–´ìˆì–´ì„œ ì €ì¥í•  ìˆ˜ ì—†ì–´ìš”.");
              return;
            }
            if (!WEBAPP_URL || WEBAPP_URL.includes("PASTE_YOUR_EXEC_URL_HERE")){
              toast("WEBAPP_URLì— /exec ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.");
              return;
            }

            toast("ì €ì¥ ìš”ì²­ ì „ì†¡ ì¤‘â€¦");
            try{
              await saveToSheet({
                title: titleText,
                current: newCurrent,
                tobe: newTobe,
                status: newStatus,
                result: newResult
              });

              sub.innerHTML = `
                <span class="chip">Current: <b>${escapeHtml(newCurrent)}</b></span>
                <span class="chip">To be: <b>${escapeHtml(newTobe)}</b></span>
                <span class="${chipClass(newStatus)}">Status: <b>${escapeHtml(newStatus)}</b></span>
                <span class="chip">Result: <b>${escapeHtml(newResult)}</b></span>
              `;
              editor.classList.remove("open");
              toast("ì €ì¥ ìš”ì²­ ì™„ë£Œ! 2~5ì´ˆ í›„ Reload í•´ë³´ì„¸ìš”.");
            }catch(e){
              console.error(e);
              toast("ì €ì¥ ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸).");
            }
          }
        });

        main.appendChild(top);
        main.appendChild(sub);
        main.appendChild(editor);

        task.appendChild(badge);
        task.appendChild(main);
        task.appendChild(needBox);

        section.appendChild(task);
      });

      list.appendChild(section);
    }
  }

  async function load(){
    try{
      setStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦", null);
      rowsCount.textContent = "-";
      updatedAt.textContent = "-";
      list.innerHTML = "";

      // ìºì‹œ ë°©ì§€
      const url = SHEET_URL + (SHEET_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("CSV fetch failed: " + res.status);

      const csvText = await res.text();

      // âœ… CSVê°€ ì•„ë‹ˆë¼ HTMLì´ ì˜¤ë©´ ì—¬ê¸°ì„œ ë°”ë¡œ ì¡ì•„ì¤Œ
      if (csvText.trim().startsWith("<")){
        throw new Error("CSV ë§í¬ê°€ HTMLì„ ë°˜í™˜í•©ë‹ˆë‹¤. (publish CSV ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”)");
      }

      if (typeof Papa === "undefined"){
        throw new Error("PapaParse ë¡œë“œ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/ì°¨ë‹¨).");
      }

      const parsed = Papa.parse(csvText, { skipEmptyLines: true });
      if (!parsed.data || parsed.data.length < 2) throw new Error("CSV ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");

      const rows = parsed.data.map(r => r.map(c => String(c ?? "")));

      let headerRowIndex = -1;
      for (let i=0;i<rows.length;i++){
        const low = rows[i].map(x => x.trim().toLowerCase());
        if (low.includes("subject") && low.includes("title")) { headerRowIndex = i; break; }
      }
      if (headerRowIndex === -1) headerRowIndex = 0;

      const headers = rows[headerRowIndex].map(normalizeHeader);
      const dataRows = rows.slice(headerRowIndex + 1);

      const hLow = headers.map(h => String(h).trim().toLowerCase());
      const idx = {
        subject: hLow.indexOf("subject"),
        title: hLow.indexOf("title"),
        current: hLow.indexOf("current"),
        tobe: hLow.indexOf("to be"),
        need: hLow.indexOf("need"),
        status: hLow.indexOf("status"),
        result: hLow.indexOf("result")
      };

      if (idx.subject < 0 || idx.title < 0){
        throw new Error("í—¤ë”ì— Subject/Title ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. (ì‹œíŠ¸ í—¤ë” ì² ì í™•ì¸)");
      }

      const cleaned = dataRows.filter(r => r.some(v => String(v ?? "").trim() !== ""));
      forwardFill(cleaned, idx.subject);

      const groups = groupBySubject(cleaned, idx.subject);
      render(groups, idx);

      rowsCount.textContent = String(cleaned.length);
      updatedAt.textContent = new Date().toLocaleString();
      setStatus("ì •ìƒ ë¡œë“œ ì™„ë£Œ", true);
    }catch(e){
      setStatus("ë¡œë“œ ì‹¤íŒ¨: " + (e?.message || e), false);
      list.innerHTML = `<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br/>${escapeHtml(e?.message || String(e))}</div>`;
      console.error(e);
    }
  }

  /**
   * ì›¹ â†’ Apps Script â†’ Sheet ì—…ë°ì´íŠ¸
   * - CORS ë•Œë¬¸ì— ì‘ë‹µì„ ëª» ì½ëŠ” ê²½ìš°ê°€ ë§ì•„ì„œ "ì „ì†¡ë§Œ" ì„±ê³µ ì²˜ë¦¬í•©ë‹ˆë‹¤.
   */
  async function saveToSheet({ title, current, tobe, status, result }){
    const body = new URLSearchParams();
    body.set("action", "update");
    body.set("title", title);
    if (API_KEY) body.set("api_key", API_KEY);
    body.set("current", current ?? "");
    body.set("tobe", tobe ?? "");
    body.set("status", status ?? "");
    body.set("result", result ?? "");

    // no-corsë¡œ ì „ì†¡(ì‘ë‹µì€ ëª» ì½ì–´ë„ ì—…ë°ì´íŠ¸ëŠ” ë¨)
    await fetch(WEBAPP_URL, { method:"POST", mode:"no-cors", body });
    return true;
  }

  load();
</script>
</body>
</html>
